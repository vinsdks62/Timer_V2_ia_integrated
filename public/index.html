<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer Journalier</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(100,100,100,0.03) 2px, rgba(100,100,100,0.03) 4px),
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(100,100,100,0.03) 2px, rgba(100,100,100,0.03) 4px);
            pointer-events: none;
        }
        
        .container {
            background: linear-gradient(145deg, #2a2a2a, #1f1f1f);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 
                0 20px 60px rgba(0,0,0,0.5),
                inset 0 1px 0 rgba(255,255,255,0.1),
                inset 0 -1px 0 rgba(0,0,0,0.5);
            max-width: 600px;
            width: 100%;
            border: 1px solid rgba(120,120,120,0.2);
            position: relative;
            z-index: 1;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .user-info {
            color: #a0a0a0;
            font-size: 0.9em;
        }
        
        .user-name {
            color: #ff6b35;
            font-weight: 600;
        }
        
        .btn-logout {
            padding: 8px 15px;
            background: linear-gradient(145deg, #dc2626, #991b1b);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }
        
        .btn-logout:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(220, 38, 38, 0.4);
        }
        
        h1 {
            text-align: center;
            color: #c0c0c0;
            margin-bottom: 30px;
            font-size: 2em;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            font-weight: 700;
            letter-spacing: 1px;
        }
        
        .timer-display {
            background: linear-gradient(145deg, #3a3a3a, #2f2f2f);
            color: #e0e0e0;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 
                0 8px 20px rgba(0,0,0,0.4),
                inset 0 1px 0 rgba(255,255,255,0.1),
                inset 0 -2px 5px rgba(0,0,0,0.3);
            border: 1px solid rgba(120,120,120,0.2);
        }
        
        .timer-label {
            font-size: 1.2em;
            margin-bottom: 10px;
            opacity: 0.8;
            color: #b0b0b0;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 600;
        }
        
        .timer-value {
            font-size: 3em;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            color: #ff6b35;
            text-shadow: 0 0 10px rgba(255, 107, 53, 0.3);
        }
        
        .buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        button {
            padding: 15px 25px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            color: #fff;
            box-shadow: 
                0 4px 10px rgba(0,0,0,0.3),
                inset 0 1px 0 rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.1);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 6px 15px rgba(0,0,0,0.4),
                inset 0 1px 0 rgba(255,255,255,0.2);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-start {
            background: linear-gradient(145deg, #4a9d5f, #3d8350);
        }
        
        .btn-pause {
            background: linear-gradient(145deg, #d97706, #b45309);
        }
        
        .btn-lunch {
            background: linear-gradient(145deg, #2563eb, #1e40af);
        }
        
        .btn-end {
            background: linear-gradient(145deg, #dc2626, #991b1b);
        }
        
        .stats {
            background: linear-gradient(145deg, #2a2a2a, #1f1f1f);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(120,120,120,0.2);
            box-shadow: 
                inset 0 2px 5px rgba(0,0,0,0.3),
                0 1px 0 rgba(255,255,255,0.05);
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(120,120,120,0.2);
        }
        
        .stat-item:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            font-weight: 600;
            color: #a0a0a0;
            text-transform: uppercase;
            font-size: 0.9em;
            letter-spacing: 1px;
        }
        
        .stat-value {
            color: #ff6b35;
            font-family: 'Courier New', monospace;
            font-weight: 700;
            text-shadow: 0 0 5px rgba(255, 107, 53, 0.2);
        }
        
        .status {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 1px solid rgba(120,120,120,0.3);
            box-shadow: 
                inset 0 1px 3px rgba(0,0,0,0.3),
                0 1px 0 rgba(255,255,255,0.1);
        }
        
        .status.working {
            background: linear-gradient(145deg, #2d5a3d, #244531);
            color: #7dd3a0;
            border-color: rgba(125, 211, 160, 0.3);
        }
        
        .status.paused {
            background: linear-gradient(145deg, #5a4a2d, #4a3d24);
            color: #f5c061;
            border-color: rgba(245, 192, 97, 0.3);
        }
        
        .status.stopped {
            background: linear-gradient(145deg, #5a2d2d, #4a2424);
            color: #f08c7d;
            border-color: rgba(240, 140, 125, 0.3);
        }
        
        .separator {
            margin: 40px 0;
            border-top: 2px solid rgba(120,120,120,0.3);
            position: relative;
            box-shadow: 0 1px 0 rgba(255,255,255,0.05);
        }
        
        .separator::after {
            content: '‚öôÔ∏è';
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(145deg, #2a2a2a, #1f1f1f);
            padding: 0 15px;
            font-size: 1.5em;
        }
        
        .task-list-section h2 {
            text-align: center;
            color: #c0c0c0;
            margin-bottom: 20px;
            font-size: 1.5em;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .task-list {
            max-height: 250px;
            overflow-y: auto;
            background: linear-gradient(145deg, #2a2a2a, #1f1f1f);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(120,120,120,0.2);
        }
        
        .task-item {
            background: linear-gradient(145deg, #353535, #2a2a2a);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-item.active {
            box-shadow: 0 0 15px rgba(255, 107, 53, 0.3);
            border: 1px solid #ff6b35;
        }

        .task-name {
            color: #d0d0d0;
            font-weight: 600;
        }

        .task-controls button {
            padding: 8px 12px;
            font-size: 0.9em;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="user-info">
                Bienvenue, <span class="user-name" id="userName"></span>
            </div>
            <button class="btn-logout" id="btnLogout">üö™ D√©connexion</button>
        </div>
        
        <h1>‚è±Ô∏è Timer Journalier</h1>
        
        <div id="status" class="status stopped">Pr√™t √† commencer</div>
        
        <div class="timer-display">
            <div class="timer-label" id="currentTimerLabel">Timer Principal</div>
            <div class="timer-value" id="currentTimer">00:00:00</div>
        </div>
        
        <div class="buttons">
            <button id="btnStart" class="btn-start">‚ñ∂Ô∏è D√©but de journ√©e</button>
            <button id="btnPause" class="btn-pause" disabled>‚è∏Ô∏è Pause</button>
            <button id="btnLunch" class="btn-lunch" disabled>üç¥ Pause d√©j</button>
            <button id="btnEnd" class="btn-end" disabled>‚èπÔ∏è Fin de journ√©e</button>
        </div>
        
        <div class="stats">
            <div class="stat-item">
                <span class="stat-label">Temps de travail :</span>
                <span class="stat-value" id="workTime">00:00:00</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Temps de pause :</span>
                <span class="stat-value" id="breakTime">00:00:00</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Pause d√©jeuner :</span>
                <span class="stat-value" id="lunchTime">00:00:00</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Temps total :</span>
                <span class="stat-value" id="totalTime">00:00:00</span>
            </div>
        </div>
        
        <div class="separator"></div>
        
        <div class="task-list-section">
            <h2>üìã T√¢ches & Projets</h2>
            <div id="projectList" class="task-list">Chargement...</div>
            <div id="taskList" class="task-list" style="margin-top: 20px;">Chargement...</div>
        </div>
    </div>

    <script>
        // Configuration API
        const API_URL = 'http://localhost:3000/api';
        let token = localStorage.getItem('token');
        let currentUser = null;
        
        // √âtat de l'application
        let state = {
            isWorking: false,
            isPaused: false,
            isLunch: false,
            workSeconds: 0,
            breakSeconds: 0,
            lunchSeconds: 0,
            startTime: null,
        };

        let activeTimer = {
            type: null, // 'task', 'project', ou 'main'
            id: null,
            entryId: null,
            name: '',
            seconds: 0,
            interval: null,
            startTime: null
        };
        
        let interval = null;
        let saveInterval = null;
        
        const elements = {
            status: document.getElementById('status'),
            currentTimer: document.getElementById('currentTimer'),
            currentTimerLabel: document.getElementById('currentTimerLabel'),
            workTime: document.getElementById('workTime'),
            breakTime: document.getElementById('breakTime'),
            lunchTime: document.getElementById('lunchTime'),
            totalTime: document.getElementById('totalTime'),
            btnStart: document.getElementById('btnStart'),
            btnPause: document.getElementById('btnPause'),
            btnLunch: document.getElementById('btnLunch'),
            btnEnd: document.getElementById('btnEnd'),
            userName: document.getElementById('userName'),
            btnLogout: document.getElementById('btnLogout'),
            projectList: document.getElementById('projectList'),
            taskList: document.getElementById('taskList')
        };
        
        // --- Fonctions d'authentification et utilitaires (inchang√©es) ---
        async function checkAuth() {
            if (!token) {
                window.location.href = '/login.html';
                return false;
            }
            try {
                const response = await fetch(`${API_URL}/auth/verify`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) {
                    localStorage.clear();
                    alert('Session expir√©e, veuillez vous reconnecter.');
                    window.location.href = '/login.html';
                    return false;
                }
                currentUser = JSON.parse(localStorage.getItem('user'));
                elements.userName.textContent = `${currentUser.first_name} ${currentUser.last_name}`;
                return true;
            } catch (error) {
                console.error('Erreur Auth:', error);
                return false;
            }
        }

        elements.btnLogout.addEventListener('click', () => {
            if (confirm('Voulez-vous vraiment vous d√©connecter ?')) {
                localStorage.clear();
                window.location.href = '/login.html';
            }
        });
        
        function formatTime(seconds) {
            seconds = Math.floor(seconds);
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }
        
        function updateDisplay() {
            elements.workTime.textContent = formatTime(state.workSeconds);
            elements.breakTime.textContent = formatTime(state.breakSeconds);
            elements.lunchTime.textContent = formatTime(state.lunchSeconds);
            elements.totalTime.textContent = formatTime(state.workSeconds + state.breakSeconds + state.lunchSeconds);
            
            if (activeTimer.type === 'main') {
                elements.currentTimerLabel.textContent = 'Timer Principal';
                elements.currentTimer.textContent = formatTime(state.workSeconds);
            } else if (activeTimer.name) {
                elements.currentTimerLabel.textContent = activeTimer.name;
                elements.currentTimer.textContent = formatTime(activeTimer.seconds);
            }
        }
        
        // --- Logique du Timer principal ---

        function tick() {
            if (state.isWorking && !state.isPaused && !state.isLunch) {
                state.workSeconds++;
                if (activeTimer.type !== 'main') {
                    activeTimer.seconds++;
                }
            } else if (state.isPaused) {
                state.breakSeconds++;
            } else if (state.isLunch) {
                state.lunchSeconds++;
            }
            updateDisplay();
        }

        function startWorkday() {
            state.isWorking = true;
            state.startTime = Date.now();
            interval = setInterval(tick, 1000);
            saveInterval = setInterval(saveWorkSession, 15000);
            activeTimer.type = 'main';
            updateUI();
        }

        function togglePause() {
            state.isPaused = !state.isPaused;
            if (state.isPaused) state.isLunch = false;
            updateUI();
        }

        function toggleLunch() {
            state.isLunch = !state.isLunch;
            if (state.isLunch) state.isPaused = false;
            updateUI();
        }

        async function endDay() {
            if (!confirm('Voulez-vous vraiment terminer la journ√©e ?')) return;
            state.isWorking = false;
            clearInterval(interval);
            clearInterval(saveInterval);
            if(activeTimer.id) await stopActivityTimer(activeTimer.type, activeTimer.id);
            await saveWorkSession();
            await fetch(`${API_URL}/work-sessions/end-day`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }});
            updateUI();
            alert('Journ√©e termin√©e !');
        }

        function updateUI() {
            elements.btnStart.disabled = state.isWorking;
            elements.btnPause.disabled = !state.isWorking;
            elements.btnLunch.disabled = !state.isWorking;
            elements.btnEnd.disabled = !state.isWorking;

            if (state.isWorking) {
                if (state.isPaused) {
                    elements.status.className = 'status paused';
                    elements.status.textContent = 'En pause';
                    elements.btnPause.textContent = '‚ñ∂Ô∏è Reprendre';
                } else if (state.isLunch) {
                    elements.status.className = 'status paused';
                    elements.status.textContent = 'Pause D√©jeuner';
                    elements.btnLunch.textContent = '‚ñ∂Ô∏è Reprendre';
                } else {
                    elements.status.className = 'status working';
                    elements.status.textContent = 'Travail en cours';
                    elements.btnPause.textContent = '‚è∏Ô∏è Pause';
                    elements.btnLunch.textContent = 'üç¥ Pause D√©j';
                }
            } else {
                elements.status.className = 'status stopped';
                elements.status.textContent = 'Journ√©e termin√©e';
            }
        }

        // --- Logique des T√¢ches & Projets ---

        async function loadTasksAndProjects() {
            const [tasksRes, projectsRes] = await Promise.all([
                fetch(`${API_URL}/tasks`, { headers: { 'Authorization': `Bearer ${token}` } }),
                fetch(`${API_URL}/projects`, { headers: { 'Authorization': `Bearer ${token}` } })
            ]);
            const tasks = await tasksRes.json();
            const projects = await projectsRes.json();
            
            renderList(elements.projectList, projects, 'project', 'Projets');
            renderList(elements.taskList, tasks, 'task', 'T√¢ches');
        }

        function renderList(container, items, type, title) {
            if (items.length === 0) {
                container.innerHTML = `<p style="color: #a0a0a0; text-align: center;">Aucun(e) ${title.toLowerCase()} trouv√©(e).</p>`;
                return;
            }
            container.innerHTML = items.map(item => `
                <div class="task-item" id="item-${type}-${item.id}">
                    <span class="task-name">${item.name}</span>
                    <div class="task-controls">
                        <button class="btn-start" onclick="startActivityTimer('${type}', ${item.id}, '${item.name.replace(/'/g, "\\'")}')">‚ñ∂Ô∏è</button>
                    </div>
                </div>
            `).join('');
        }

        async function startActivityTimer(type, id, name) {
            if (!state.isWorking) {
                alert("Veuillez d'abord d√©marrer la journ√©e.");
                return;
            }

            if (activeTimer.id) {
                if (activeTimer.id === id && activeTimer.type === type) return; // D√©j√† en cours
                await stopActivityTimer(activeTimer.type, activeTimer.id);
            }
            
            const currentActivityDescription = prompt('Veuillez d√©crire votre activit√© (ex: "R√©union √©quipe projet X"):');
            if (!currentActivityDescription) {
                 alert('La description est obligatoire pour d√©marrer un timer.');
                 return;
            }

            try {
                const response = await fetch(`${API_URL}/time-entries/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({
                        task_id: type === 'task' ? id : null,
                        project_id: type === 'project' ? id : null,
                        description: currentActivityDescription
                    })
                });
                const data = await response.json();

                activeTimer = { type, id, name, entryId: data.entry_id, seconds: 0, startTime: Date.now() };

                // Mettre √† jour l'UI
                document.querySelectorAll('.task-item').forEach(el => el.classList.remove('active'));
                document.getElementById(`item-${type}-${id}`).classList.add('active');
                updateDisplay();

            } catch (error) {
                console.error("Erreur au d√©marrage de l'activit√©:", error);
            }
        }
        
        async function stopActivityTimer(type, id) {
            if (!activeTimer.id) return;

            try {
                await fetch(`${API_URL}/time-entries/${activeTimer.entryId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ duration_seconds: activeTimer.seconds })
                });

                activeTimer = { type: 'main', id: null, name: '', entryId: null, seconds: 0, interval: null, startTime: null };

                document.querySelectorAll('.task-item').forEach(el => el.classList.remove('active'));
                updateDisplay();
                
            } catch (error) {
                console.error("Erreur √† l'arr√™t de l'activit√©:", error);
            }
        }
        
        // --- Sauvegarde & Initialisation ---

        async function saveWorkSession() {
            if (!state.isWorking) return;
            try {
                await fetch(`${API_URL}/work-sessions/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({
                        work_seconds: state.workSeconds,
                        break_seconds: state.breakSeconds,
                        lunch_seconds: state.lunchSeconds
                    })
                });
            } catch (error) {
                console.error('Erreur de sauvegarde:', error);
            }
        }
        
        window.addEventListener('load', async () => {
            const authenticated = await checkAuth();
            if (authenticated) {
                try {
                    const response = await fetch(`${API_URL}/work-sessions/today`, { headers: { 'Authorization': `Bearer ${token}` } });
                    const data = await response.json();
                    
                    if (data.end_time) {
                        state.workSeconds = data.work_seconds || 0;
                        state.breakSeconds = data.break_seconds || 0;
                        state.lunchSeconds = data.lunch_seconds || 0;
                        state.isWorking = false;
                        updateDisplay();
                        updateUI();
                        elements.status.textContent = 'üèÅ Journ√©e termin√©e';
                        elements.btnStart.disabled = true;
                    } else if (data.work_seconds > 0 || data.break_seconds > 0 || data.lunch_seconds > 0) {
                        // Pour l'instant, on ne restaure pas un timer en cours pour simplifier. 
                        // L'utilisateur doit red√©marrer sa journ√©e.
                        state.workSeconds = data.work_seconds || 0;
                        state.breakSeconds = data.break_seconds || 0;
                        state.lunchSeconds = data.lunch_seconds || 0;
                        updateDisplay();
                    }
                } catch (e) {
                    console.error("Impossible de charger la session du jour", e);
                }
                
                await loadTasksAndProjects();

                elements.btnStart.addEventListener('click', startWorkday);
                elements.btnPause.addEventListener('click', togglePause);
                elements.btnLunch.addEventListener('click', toggleLunch);
                elements.btnEnd.addEventListener('click', endDay);
            }
        });
    </script>
</body>
</html>
