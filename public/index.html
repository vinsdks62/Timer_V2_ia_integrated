<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer Journalier</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(100,100,100,0.03) 2px, rgba(100,100,100,0.03) 4px),
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(100,100,100,0.03) 2px, rgba(100,100,100,0.03) 4px);
            pointer-events: none;
        }
        
        .container {
            background: linear-gradient(145deg, #2a2a2a, #1f1f1f);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 
                0 20px 60px rgba(0,0,0,0.5),
                inset 0 1px 0 rgba(255,255,255,0.1),
                inset 0 -1px 0 rgba(0,0,0,0.5);
            max-width: 600px;
            width: 100%;
            border: 1px solid rgba(120,120,120,0.2);
            position: relative;
            z-index: 1;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .user-info {
            color: #a0a0a0;
            font-size: 0.9em;
        }
        
        .user-name {
            color: #ff6b35;
            font-weight: 600;
        }
        
        .btn-logout {
            padding: 8px 15px;
            background: linear-gradient(145deg, #dc2626, #991b1b);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }
        
        .btn-logout:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(220, 38, 38, 0.4);
        }
        
        h1 {
            text-align: center;
            color: #c0c0c0;
            margin-bottom: 30px;
            font-size: 2em;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            font-weight: 700;
            letter-spacing: 1px;
        }
        
        .timer-display {
            background: linear-gradient(145deg, #3a3a3a, #2f2f2f);
            color: #e0e0e0;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 
                0 8px 20px rgba(0,0,0,0.4),
                inset 0 1px 0 rgba(255,255,255,0.1),
                inset 0 -2px 5px rgba(0,0,0,0.3);
            border: 1px solid rgba(120,120,120,0.2);
        }
        
        .timer-label {
            font-size: 1.2em;
            margin-bottom: 10px;
            opacity: 0.8;
            color: #b0b0b0;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 600;
        }
        
        .timer-value {
            font-size: 3em;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            color: #ff6b35;
            text-shadow: 0 0 10px rgba(255, 107, 53, 0.3);
        }
        
        .buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        button {
            padding: 15px 25px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            color: #fff;
            box-shadow: 
                0 4px 10px rgba(0,0,0,0.3),
                inset 0 1px 0 rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.1);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 6px 15px rgba(0,0,0,0.4),
                inset 0 1px 0 rgba(255,255,255,0.2);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-start {
            background: linear-gradient(145deg, #4a9d5f, #3d8350);
        }
        
        .btn-pause {
            background: linear-gradient(145deg, #d97706, #b45309);
        }
        
        .btn-lunch {
            background: linear-gradient(145deg, #2563eb, #1e40af);
        }
        
        .btn-end {
            background: linear-gradient(145deg, #dc2626, #991b1b);
        }
        
        .stats {
            background: linear-gradient(145deg, #2a2a2a, #1f1f1f);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(120,120,120,0.2);
            box-shadow: 
                inset 0 2px 5px rgba(0,0,0,0.3),
                0 1px 0 rgba(255,255,255,0.05);
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(120,120,120,0.2);
        }
        
        .stat-item:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            font-weight: 600;
            color: #a0a0a0;
            text-transform: uppercase;
            font-size: 0.9em;
            letter-spacing: 1px;
        }
        
        .stat-value {
            color: #ff6b35;
            font-family: 'Courier New', monospace;
            font-weight: 700;
            text-shadow: 0 0 5px rgba(255, 107, 53, 0.2);
        }
        
        .status {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 1px solid rgba(120,120,120,0.3);
            box-shadow: 
                inset 0 1px 3px rgba(0,0,0,0.3),
                0 1px 0 rgba(255,255,255,0.1);
        }
        
        .status.working {
            background: linear-gradient(145deg, #2d5a3d, #244531);
            color: #7dd3a0;
            border-color: rgba(125, 211, 160, 0.3);
        }
        
        .status.paused {
            background: linear-gradient(145deg, #5a4a2d, #4a3d24);
            color: #f5c061;
            border-color: rgba(245, 192, 97, 0.3);
        }
        
        .status.stopped {
            background: linear-gradient(145deg, #5a2d2d, #4a2424);
            color: #f08c7d;
            border-color: rgba(240, 140, 125, 0.3);
        }
        
        .separator {
            margin: 40px 0;
            border-top: 2px solid rgba(120,120,120,0.3);
            position: relative;
            box-shadow: 0 1px 0 rgba(255,255,255,0.05);
        }
        
        .separator::after {
            content: '⚙️';
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(145deg, #2a2a2a, #1f1f1f);
            padding: 0 15px;
            font-size: 1.5em;
        }
        
        .project-section h2 {
            text-align: center;
            color: #c0c0c0;
            margin-bottom: 20px;
            font-size: 1.5em;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .project-select-group {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .project-select-group select {
            padding: 12px;
            border: 1px solid rgba(120,120,120,0.3);
            border-radius: 8px;
            font-size: 1em;
            background: linear-gradient(145deg, #2a2a2a, #1f1f1f);
            color: #e0e0e0;
            cursor: pointer;
            box-shadow: 
                inset 0 2px 5px rgba(0,0,0,0.3),
                0 1px 0 rgba(255,255,255,0.05);
        }
        
        .project-select-group select:focus {
            outline: none;
            border-color: #ff6b35;
            box-shadow: 
                inset 0 2px 5px rgba(0,0,0,0.3),
                0 0 0 2px rgba(255, 107, 53, 0.2);
        }
        
        .project-timer {
            background: linear-gradient(145deg, #3a3a3a, #2f2f2f);
            color: #e0e0e0;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 
                0 8px 20px rgba(0,0,0,0.4),
                inset 0 1px 0 rgba(255,255,255,0.1),
                inset 0 -2px 5px rgba(0,0,0,0.3);
            border: 1px solid rgba(120,120,120,0.2);
        }
        
        .project-timer-label {
            font-size: 1em;
            margin-bottom: 8px;
            opacity: 0.8;
            color: #b0b0b0;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 600;
        }
        
        .project-timer-value {
            font-size: 2.5em;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            color: #ff6b35;
            text-shadow: 0 0 10px rgba(255, 107, 53, 0.3);
        }
        
        .project-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .project-controls button {
            flex: 1;
        }
        
        .btn-project-start {
            background: linear-gradient(145deg, #4a9d5f, #3d8350);
        }
        
        .btn-project-stop {
            background: linear-gradient(145deg, #dc2626, #991b1b);
        }
        
        .projects-list {
            background: linear-gradient(145deg, #2a2a2a, #1f1f1f);
            padding: 20px;
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid rgba(120,120,120,0.2);
            box-shadow: 
                inset 0 2px 5px rgba(0,0,0,0.3),
                0 1px 0 rgba(255,255,255,0.05);
        }
        
        .projects-list h3 {
            margin-bottom: 15px;
            color: #a0a0a0;
            font-size: 1.1em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .project-item {
            background: linear-gradient(145deg, #353535, #2a2a2a);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(120,120,120,0.2);
            box-shadow: 
                0 2px 5px rgba(0,0,0,0.3),
                inset 0 1px 0 rgba(255,255,255,0.05);
        }
        
        .project-item:last-child {
            margin-bottom: 0;
        }
        
        .project-name {
            font-weight: 600;
            color: #d0d0d0;
            flex: 1;
        }
        
        .project-time {
            font-family: 'Courier New', monospace;
            color: #ff6b35;
            margin-left: 15px;
            font-weight: 700;
            text-shadow: 0 0 5px rgba(255, 107, 53, 0.2);
        }
        
        .charts-section {
            margin-top: 40px;
        }
        
        .charts-section h2 {
            text-align: center;
            color: #c0c0c0;
            margin-bottom: 20px;
            font-size: 1.5em;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .chart-box {
            background: linear-gradient(145deg, #2a2a2a, #1f1f1f);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(120,120,120,0.2);
            box-shadow: 
                inset 0 2px 5px rgba(0,0,0,0.3),
                0 1px 0 rgba(255,255,255,0.05);
        }
        
        .chart-box h3 {
            text-align: center;
            color: #a0a0a0;
            margin-bottom: 15px;
            font-size: 1em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .pie-chart {
            width: 200px;
            height: 200px;
            margin: 0 auto;
            border-radius: 50%;
            position: relative;
            box-shadow: 
                0 5px 15px rgba(0,0,0,0.4),
                inset 0 0 20px rgba(0,0,0,0.3);
        }
        
        .chart-legend {
            margin-top: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            box-shadow: 
                0 2px 5px rgba(0,0,0,0.3),
                inset 0 1px 0 rgba(255,255,255,0.2);
        }
        
        .legend-label {
            flex: 1;
            font-size: 0.9em;
            color: #a0a0a0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .legend-value {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: #ff6b35;
            text-shadow: 0 0 5px rgba(255, 107, 53, 0.2);
        }
        
        .bar-chart {
            margin-top: 20px;
        }
        
        .bar-item {
            margin-bottom: 15px;
        }
        
        .bar-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #a0a0a0;
        }
        
        .bar-track {
            width: 100%;
            height: 25px;
            background: linear-gradient(145deg, #1a1a1a, #252525);
            border-radius: 5px;
            overflow: hidden;
            border: 1px solid rgba(120,120,120,0.2);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.4);
        }
        
        .bar-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            color: white;
            font-size: 0.85em;
            font-weight: 600;
            box-shadow: 
                0 0 10px rgba(255, 107, 53, 0.3),
                inset 0 1px 0 rgba(255,255,255,0.2);
        }
        
        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="user-info">
                Bienvenue, <span class="user-name" id="userName"></span>
            </div>
            <button class="btn-logout" id="btnLogout">🚪 Déconnexion</button>
        </div>
        
        <h1>⏱️ Timer Journalier</h1>
        
        <div id="status" class="status stopped">Prêt à commencer</div>
        
        <div class="timer-display">
            <div class="timer-label" id="currentTimerLabel">Timer Principal</div>
            <div class="timer-value" id="currentTimer">00:00:00</div>
        </div>
        
        <div class="buttons">
            <button id="btnStart" class="btn-start">▶️ Début de journée</button>
            <button id="btnPause" class="btn-pause" disabled>⏸️ Pause</button>
            <button id="btnLunch" class="btn-lunch" disabled>🍴 Pause déj</button>
            <button id="btnEnd" class="btn-end" disabled>⏹️ Fin de journée</button>
        </div>
        
        <div class="stats">
            <div class="stat-item">
                <span class="stat-label">Temps de travail :</span>
                <span class="stat-value" id="workTime">00:00:00</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Temps de pause :</span>
                <span class="stat-value" id="breakTime">00:00:00</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Pause déjeuner :</span>
                <span class="stat-value" id="lunchTime">00:00:00</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Temps total :</span>
                <span class="stat-value" id="totalTime">00:00:00</span>
            </div>
        </div>
        
        <div class="separator"></div>
        
        <div class="project-section">
            <h2>📋 Tâches & Projets</h2>
            
            <div class="project-select-group">
                <select id="categorySelect">
                    <option value="">-- Catégorie --</option>
                    <option value="tasks">Tâches</option>
                    <option value="projects">Projets</option>
                </select>
                <select id="itemSelect" disabled>
                    <option value="">-- Sélectionner --</option>
                </select>
            </div>
            
            <div class="project-timer">
                <div class="project-timer-label" id="projectTimerLabel">Aucun projet en cours</div>
                <div class="project-timer-value" id="projectTimer">00:00:00</div>
            </div>
            
            <div class="project-controls">
                <button id="btnStartProject" class="btn-project-start" disabled>▶️ Démarrer</button>
                <button id="btnStopProject" class="btn-project-stop" disabled>⏹️ Arrêter</button>
            </div>
            
            <div class="projects-list">
                <h3>📊 Historique</h3>
                <div id="projectsList">Chargement...</div>
            </div>
        </div>
        
        <div class="separator"></div>
        
        <div class="charts-section">
            <h2>📊 Statistiques Visuelles</h2>
            
            <div class="charts-container">
                <div class="chart-box">
                    <h3>Répartition du temps journalier</h3>
                    <div class="pie-chart" id="dailyPieChart"></div>
                    <div class="chart-legend" id="dailyLegend"></div>
                </div>
                
                <div class="chart-box">
                    <h3>Top 5 Tâches/Projets</h3>
                    <div class="bar-chart" id="projectsBarChart"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration API
        const API_URL = 'http://localhost:3000/api';
        let token = localStorage.getItem('token');
        let currentUser = null;
        
        // État de l'application
        let state = {
            isWorking: false,
            isPaused: false,
            isLunch: false,
            workSeconds: 0,
            breakSeconds: 0,
            lunchSeconds: 0,
            startTime: null,
            currentSessionStart: null
        };
        
        let projectState = {
            tasks: [],
            projects: [],
            currentCategory: null,
            currentItem: null,
            currentItemId: null,
            currentEntryId: null,
            currentItemSeconds: 0,
            isRunning: false,
            startTimestamp: null
        };
        
        let interval = null;
        let projectInterval = null;
        let saveInterval = null;
        
        const elements = {
            status: document.getElementById('status'),
            currentTimer: document.getElementById('currentTimer'),
            currentTimerLabel: document.getElementById('currentTimerLabel'),
            workTime: document.getElementById('workTime'),
            breakTime: document.getElementById('breakTime'),
            lunchTime: document.getElementById('lunchTime'),
            totalTime: document.getElementById('totalTime'),
            btnStart: document.getElementById('btnStart'),
            btnPause: document.getElementById('btnPause'),
            btnLunch: document.getElementById('btnLunch'),
            btnEnd: document.getElementById('btnEnd'),
            userName: document.getElementById('userName'),
            btnLogout: document.getElementById('btnLogout')
        };
        
        // ============================================
        // SYSTÈME DE PERSISTANCE D'ÉTAT
        // ============================================
        
        const STATE_KEY = 'timer_app_state';
        const STATE_TIMESTAMP_KEY = 'timer_app_state_timestamp';
        
        function saveCompleteState() {
            const completeState = {
                mainTimer: {
                    isWorking: state.isWorking,
                    isPaused: state.isPaused,
                    isLunch: state.isLunch,
                    workSeconds: state.workSeconds,
                    breakSeconds: state.breakSeconds,
                    lunchSeconds: state.lunchSeconds,
                    startTime: state.startTime,
                    currentSessionStart: state.currentSessionStart
                },
                projectTimer: {
                    currentCategory: projectState.currentCategory,
                    currentItem: projectState.currentItem,
                    currentItemId: projectState.currentItemId,
                    currentEntryId: projectState.currentEntryId,
                    currentItemSeconds: projectState.currentItemSeconds,
                    isRunning: projectState.isRunning,
                    startTimestamp: projectState.startTimestamp || null
                },
                timestamp: Date.now()
            };
            
            localStorage.setItem(STATE_KEY, JSON.stringify(completeState));
            localStorage.setItem(STATE_TIMESTAMP_KEY, Date.now().toString());
    localStorage.setItem('saved_user_id', currentUser.id);
        }
        
        async function restoreCompleteState() {
            try {
                const savedState = localStorage.getItem(STATE_KEY);
                const savedTimestamp = localStorage.getItem(STATE_TIMESTAMP_KEY);
                
                if (!savedState || !savedTimestamp) {
                    console.log('Aucun état sauvegardé trouvé');
                    return false;
                }
                
                const parsedState = JSON.parse(savedState);

                // Vérifier que l'état appartient à l'utilisateur actuel
                const savedUserId = localStorage.getItem('saved_user_id');
                if (savedUserId && savedUserId != currentUser.id) {
                    console.log('État sauvegardé appartient à un autre utilisateur, ignoré');
                    localStorage.removeItem(STATE_KEY);
                    localStorage.removeItem(STATE_TIMESTAMP_KEY);
        localStorage.removeItem('saved_user_id');
                    localStorage.removeItem('saved_user_id');
                    return false;
                }
                const elapsedTime = Math.floor((Date.now() - parseInt(savedTimestamp)) / 1000);
                
                console.log(`⏱️ Temps écoulé depuis la dernière sauvegarde: ${elapsedTime}s`);
                
                state.isWorking = parsedState.mainTimer.isWorking;
                state.isPaused = parsedState.mainTimer.isPaused;
                state.isLunch = parsedState.mainTimer.isLunch;
                state.workSeconds = parsedState.mainTimer.workSeconds;
                state.breakSeconds = parsedState.mainTimer.breakSeconds;
                state.lunchSeconds = parsedState.mainTimer.lunchSeconds;
                state.startTime = parsedState.mainTimer.startTime;
                state.currentSessionStart = parsedState.mainTimer.currentSessionStart;
                
                if (state.isWorking && !state.isPaused && !state.isLunch) {
                    state.workSeconds += elapsedTime;
                    console.log(`✅ Temps de travail ajusté: +${elapsedTime}s`);
                } else if (state.isPaused) {
                    state.breakSeconds += elapsedTime;
                    console.log(`⏸️ Temps de pause ajusté: +${elapsedTime}s`);
                } else if (state.isLunch) {
                    state.lunchSeconds += elapsedTime;
                    console.log(`🍴 Temps déjeuner ajusté: +${elapsedTime}s`);
                }
                
                projectState.currentCategory = parsedState.projectTimer.currentCategory;
                projectState.currentItem = parsedState.projectTimer.currentItem;
                projectState.currentItemId = parsedState.projectTimer.currentItemId;
                projectState.currentEntryId = parsedState.projectTimer.currentEntryId;
                projectState.currentItemSeconds = parsedState.projectTimer.currentItemSeconds;
                projectState.isRunning = parsedState.projectTimer.isRunning;
                projectState.startTimestamp = parsedState.projectTimer.startTimestamp;
                
                if (projectState.isRunning) {
                    projectState.currentItemSeconds += elapsedTime;
                    console.log(`📋 Temps projet/tâche ajusté: +${elapsedTime}s`);
                }
                
                if (state.isWorking) {
                    interval = setInterval(tick, 1000);
                    saveInterval = setInterval(saveWorkSession, 30000);
                    
                    elements.btnStart.disabled = true;
                    elements.btnPause.disabled = false;
                    elements.btnLunch.disabled = false;
                    elements.btnEnd.disabled = false;
                    
                    if (state.isPaused) {
                        elements.status.textContent = '⏸️ En pause';
                        elements.status.className = 'status paused';
                        elements.currentTimerLabel.textContent = 'Durée de la pause';
                        elements.currentTimer.textContent = formatTime(state.breakSeconds);
                        elements.btnPause.textContent = '▶️ Reprendre';
                        elements.btnLunch.disabled = true;
                    } else if (state.isLunch) {
                        elements.status.textContent = '🍴 Pause déjeuner';
                        elements.status.className = 'status paused';
                        elements.currentTimerLabel.textContent = 'Durée pause déjeuner';
                        elements.currentTimer.textContent = formatTime(state.lunchSeconds);
                        elements.btnLunch.textContent = '▶️ Reprendre';
                        elements.btnPause.disabled = true;
                    } else {
                        elements.status.textContent = '✅ Travail en cours';
                        elements.status.className = 'status working';
                        elements.currentTimerLabel.textContent = 'Temps de travail';
                        elements.currentTimer.textContent = formatTime(state.workSeconds);
                        elements.btnPause.textContent = '⏸️ Pause';
                        elements.btnLunch.textContent = '🍴 Pause déj';
                    }
                }
                
                if (projectState.isRunning && projectState.currentItem) {
                    projectElements.projectTimerLabel.textContent = projectState.currentItem;
                    projectElements.projectTimer.textContent = formatTime(projectState.currentItemSeconds);
                    projectElements.btnStartProject.disabled = true;
                    projectElements.btnStopProject.disabled = false;
                    projectElements.categorySelect.disabled = true;
                    projectElements.itemSelect.disabled = true;
                    projectElements.categorySelect.value = projectState.currentCategory;
                    
                    projectInterval = setInterval(() => {
                        projectState.currentItemSeconds++;
                        projectElements.projectTimer.textContent = formatTime(projectState.currentItemSeconds);
                        saveCompleteState();
                    }, 1000);
                }
                
                updateDisplay();
                updateCharts();
                
                console.log('✅ État restauré avec succès');
                
                await saveWorkSession();
                
                return true;
            } catch (error) {
                console.error('❌ Erreur lors de la restauration:', error);
                localStorage.removeItem(STATE_KEY);
                localStorage.removeItem(STATE_TIMESTAMP_KEY);
        localStorage.removeItem('saved_user_id');
                return false;
            }
        }
        
        function clearSavedState() {
            localStorage.removeItem(STATE_KEY);
            localStorage.removeItem(STATE_TIMESTAMP_KEY);
        localStorage.removeItem('saved_user_id');
            console.log('🧹 État sauvegardé nettoyé');
        }
        
        setInterval(saveCompleteState, 5000);
        
        window.addEventListener('beforeunload', (e) => {
            saveCompleteState();
            if (state.isWorking) {
                saveWorkSession();
            }
        });
        
        window.addEventListener('blur', () => {
            saveCompleteState();
        });
        
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                saveCompleteState();
            }
        });
        
        // ============================================
        // AUTHENTIFICATION
        // ============================================
        
        async function checkAuth() {
            if (!token) {
                window.location.href = '/login.html';
                return false;
            }
            
            try {
                const response = await fetch(`${API_URL}/auth/verify`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    console.warn('⚠️ Vérification token échouée, nouvelle tentative dans 5s...');
                    
                    setTimeout(async () => {
                        const retryResponse = await fetch(`${API_URL}/auth/verify`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        
                        if (!retryResponse.ok) {
                            console.error('❌ Token invalide après 2 tentatives');
                            localStorage.removeItem('token');
                            localStorage.removeItem('user');
                            clearSavedState();
                            alert('⚠️ Votre session a expiré. Veuillez vous reconnecter.');
                            window.location.href = '/login.html';
                        }
                    }, 5000);
                    
                    return true;
                }
                
                currentUser = JSON.parse(localStorage.getItem('user'));
                elements.userName.textContent = `${currentUser.first_name} ${currentUser.last_name}`;
                
                return true;
            } catch (error) {
                console.error('Erreur vérification auth:', error);
                console.warn('⚠️ Erreur réseau, on continue avec le token existant');
                return true;
            }
        }
        
        elements.btnLogout.addEventListener('click', () => {
            if (confirm('Voulez-vous vraiment vous déconnecter ?\n\n⚠️ Vos timers en cours seront arrêtés.')) {
                clearInterval(interval);
                clearInterval(projectInterval);
                clearInterval(saveInterval);
                
                if (state.isWorking) {
                    saveWorkSession();
                }
                
                clearSavedState();
                
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                
                window.location.href = '/login.html';
            }
        });
        
        // ============================================
        // FONCTIONS UTILITAIRES
        // ============================================
        
        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }
        
        function updateDisplay() {
            elements.workTime.textContent = formatTime(state.workSeconds);
            elements.breakTime.textContent = formatTime(state.breakSeconds);
            elements.lunchTime.textContent = formatTime(state.lunchSeconds);
            elements.totalTime.textContent = formatTime(state.workSeconds + state.breakSeconds + state.lunchSeconds);
        }
        
        async function saveWorkSession() {
            try {
                await fetch(`${API_URL}/work-sessions/update`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        work_seconds: state.workSeconds,
                        break_seconds: state.breakSeconds,
                        lunch_seconds: state.lunchSeconds
                    })
                });
            } catch (error) {
                console.error('Erreur sauvegarde session:', error);
            }
        }
        
        async function loadTodaySession() {
            try {
                const response = await fetch(`${API_URL}/work-sessions/today`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    state.workSeconds = data.work_seconds || 0;
                    state.breakSeconds = data.break_seconds || 0;
                    state.lunchSeconds = data.lunch_seconds || 0;
                    
                    if (data.end_time) {
                        lockDayAsFinished();
                    }
                    
                    updateDisplay();
                    updateCharts();
                }
            } catch (error) {
                console.error('Erreur chargement session:', error);
            }
        }
        
        function lockDayAsFinished() {
            state.isWorking = false;
            state.isPaused = false;
            state.isLunch = false;
            
            elements.status.textContent = '🏁 Journée terminée - Rendez-vous demain !';
            elements.status.className = 'status stopped';
            elements.currentTimerLabel.textContent = 'Journée terminée';
            
            elements.btnStart.disabled = true;
            elements.btnPause.disabled = true;
            elements.btnLunch.disabled = true;
            elements.btnEnd.disabled = true;
            
            clearInterval(interval);
            clearInterval(saveInterval);
        }
        
        // ============================================
        // GESTION DU TIMER PRINCIPAL
        // ============================================
        
        function updateCharts() {
            updateDailyPieChart();
            updateProjectsBarChart();
        }
        
        function updateDailyPieChart() {
            const total = state.workSeconds + state.breakSeconds + state.lunchSeconds;
            if (total === 0) {
                document.getElementById('dailyPieChart').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 200px; color: #9ca3af;">Aucune donnée</div>';
                document.getElementById('dailyLegend').innerHTML = '';
                return;
            }
            
            const data = [
                { label: 'Travail', seconds: state.workSeconds, color: '#10b981' },
                { label: 'Pauses', seconds: state.breakSeconds, color: '#f59e0b' },
                { label: 'Déjeuner', seconds: state.lunchSeconds, color: '#3b82f6' }
            ];
            
            let currentAngle = 0;
            const gradientParts = [];
            
            data.forEach(item => {
                const angle = (item.seconds / total) * 360;
                
                if (item.seconds > 0) {
                    gradientParts.push(`${item.color} ${currentAngle}deg ${currentAngle + angle}deg`);
                    currentAngle += angle;
                }
            });
            
            const pieChart = document.getElementById('dailyPieChart');
            pieChart.style.background = `conic-gradient(${gradientParts.join(', ')})`;
            
            const legendHTML = data.map(item => {
                const percentage = total > 0 ? ((item.seconds / total) * 100).toFixed(1) : 0;
                return `
                    <div class="legend-item">
                        <div class="legend-color" style="background: ${item.color}"></div>
                        <div class="legend-label">${item.label}</div>
                        <div class="legend-value">${percentage}%</div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('dailyLegend').innerHTML = legendHTML;
        }
        
        async function updateProjectsBarChart() {
            try {
                const response = await fetch(`${API_URL}/time-entries/history`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) return;
                
                const entries = await response.json();
                
                const grouped = {};
                entries.forEach(entry => {
                    const name = entry.task_name || entry.project_name;
                    if (!grouped[name]) {
                        grouped[name] = 0;
                    }
                    grouped[name] += entry.duration_seconds;
                });
                
                const sorted = Object.entries(grouped)
                    .map(([name, seconds]) => ({ name, seconds }))
                    .sort((a, b) => b.seconds - a.seconds)
                    .slice(0, 5);
                
                if (sorted.length === 0) {
                    document.getElementById('projectsBarChart').innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 20px;">Aucune activité</p>';
                    return;
                }
                
                const maxSeconds = Math.max(...sorted.map(p => p.seconds));
                const colors = ['#ff6b35', '#d97706', '#2563eb', '#dc2626', '#4a9d5f'];
                
                const barsHTML = sorted.map((item, index) => {
                    const percentage = maxSeconds > 0 ? (item.seconds / maxSeconds) * 100 : 0;
                    const hours = (item.seconds / 3600).toFixed(1);
                    
                    return `
                        <div class="bar-item">
                            <div class="bar-label">
                                <span>${item.name}</span>
                                <span>${formatTime(item.seconds)}</span>
                            </div>
                            <div class="bar-track">
                                <div class="bar-fill" style="width: ${percentage}%; background: ${colors[index]};">
                                    ${hours}h
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('projectsBarChart').innerHTML = barsHTML;
            } catch (error) {
                console.error('Erreur chargement graphique:', error);
            }
        }
        
        function tick() {
            if (state.isWorking && !state.isPaused && !state.isLunch) {
                state.workSeconds++;
                elements.currentTimer.textContent = formatTime(state.workSeconds);
            } else if (state.isPaused) {
                state.breakSeconds++;
                elements.currentTimer.textContent = formatTime(state.breakSeconds);
            } else if (state.isLunch) {
                state.lunchSeconds++;
                elements.currentTimer.textContent = formatTime(state.lunchSeconds);
            }
            updateDisplay();
            updateCharts();
            saveCompleteState();
        }
        
        function startWork() {
            if (elements.btnStart.disabled) {
                alert('⚠️ Vous ne pouvez plus démarrer de timer aujourd\'hui.\nLa journée a été marquée comme terminée.');
                return;
            }
            
            state.isWorking = true;
            state.startTime = Date.now();
            state.currentSessionStart = Date.now();
            interval = setInterval(tick, 1000);
            
            saveInterval = setInterval(saveWorkSession, 30000);
            
            elements.status.textContent = '✅ Travail en cours';
            elements.status.className = 'status working';
            elements.currentTimerLabel.textContent = 'Temps de travail';
            elements.currentTimer.textContent = formatTime(state.workSeconds);
            
            elements.btnStart.disabled = true;
            elements.btnPause.disabled = false;
            elements.btnLunch.disabled = false;
            elements.btnEnd.disabled = false;
        }
        
        function togglePause() {
            if (state.isPaused) {
                state.isPaused = false;
                elements.status.textContent = '✅ Travail en cours';
                elements.status.className = 'status working';
                elements.currentTimerLabel.textContent = 'Temps de travail';
                elements.currentTimer.textContent = formatTime(state.workSeconds);
                elements.btnPause.textContent = '⏸️ Pause';
                elements.btnLunch.disabled = false;
            } else {
                state.isPaused = true;
                state.isLunch = false;
                elements.status.textContent = '⏸️ En pause';
                elements.status.className = 'status paused';
                elements.currentTimerLabel.textContent = 'Durée de la pause';
                elements.currentTimer.textContent = formatTime(state.breakSeconds);
                elements.btnPause.textContent = '▶️ Reprendre';
                elements.btnLunch.disabled = true;
            }
            saveWorkSession();
        }
        
        function toggleLunch() {
            if (state.isLunch) {
                state.isLunch = false;
                elements.status.textContent = '✅ Travail en cours';
                elements.status.className = 'status working';
                elements.currentTimerLabel.textContent = 'Temps de travail';
                elements.currentTimer.textContent = formatTime(state.workSeconds);
                elements.btnLunch.textContent = '🍴 Pause déj';
                elements.btnPause.disabled = false;
            } else {
                state.isLunch = true;
                state.isPaused = false;
                elements.status.textContent = '🍴 Pause déjeuner';
                elements.status.className = 'status paused';
                elements.currentTimerLabel.textContent = 'Durée pause déjeuner';
                elements.currentTimer.textContent = formatTime(state.lunchSeconds);
                elements.btnLunch.textContent = '▶️ Reprendre';
                elements.btnPause.disabled = true;
            }
            saveWorkSession();
        }
        
        async function endDay() {
            if (!confirm('⚠️ Attention : Une fois la journée terminée, vous ne pourrez plus relancer le timer avant demain.\n\nConfirmer la fin de journée ?')) {
                return;
            }
            
            clearInterval(interval);
            clearInterval(saveInterval);
            
            state.isWorking = false;
            state.isPaused = false;
            state.isLunch = false;
            
            await saveWorkSession();
            
            try {
                await fetch(`${API_URL}/work-sessions/end-day`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                lockDayAsFinished();
                
                alert('✅ Journée terminée ! À demain !');
                
            } catch (error) {
                console.error('Erreur fin de journée:', error);
                alert('❌ Erreur lors de la finalisation. Veuillez réessayer.');
            }
        }
        
        elements.btnStart.addEventListener('click', startWork);
        elements.btnPause.addEventListener('click', togglePause);
        elements.btnLunch.addEventListener('click', toggleLunch);
        elements.btnEnd.addEventListener('click', endDay);
        
        // ============================================
        // GESTION DES PROJETS/TÂCHES
        // ============================================
        
        const projectElements = {
            categorySelect: document.getElementById('categorySelect'),
            itemSelect: document.getElementById('itemSelect'),
            projectTimer: document.getElementById('projectTimer'),
            projectTimerLabel: document.getElementById('projectTimerLabel'),
            btnStartProject: document.getElementById('btnStartProject'),
            btnStopProject: document.getElementById('btnStopProject'),
            projectsList: document.getElementById('projectsList')
        };
        
        async function loadTasksAndProjects() {
            try {
                const [tasksRes, projectsRes] = await Promise.all([
                    fetch(`${API_URL}/tasks`, { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch(`${API_URL}/projects`, { headers: { 'Authorization': `Bearer ${token}` } })
                ]);
                
                projectState.tasks = await tasksRes.json();
                projectState.projects = await projectsRes.json();
                
                updateProjectsList();
            } catch (error) {
                console.error('Erreur chargement tâches/projets:', error);
            }
        }
        
        function updateItemSelect() {
            const category = projectElements.categorySelect.value;
            projectElements.itemSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
            
            if (!category) {
                projectElements.itemSelect.disabled = true;
                return;
            }
            
            projectElements.itemSelect.disabled = false;
            const items = category === 'tasks' ? projectState.tasks : projectState.projects;
            
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item.name;
                projectElements.itemSelect.appendChild(option);
            });
        }
        
        async function updateProjectsList() {
            try {
                const response = await fetch(`${API_URL}/time-entries/history`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    projectElements.projectsList.innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 20px;">Erreur de chargement</p>';
                    return;
                }
                
                const entries = await response.json();
                
                if (entries.length === 0) {
                    projectElements.projectsList.innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 20px;">Aucune activité</p>';
                    return;
                }
                
                projectElements.projectsList.innerHTML = entries.slice(0, 10).map((entry) => `
                    <div class="project-item">
                        <span class="project-name">${entry.task_name || entry.project_name}</span>
                        <span class="project-time">${formatTime(entry.duration_seconds)}</span>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Erreur chargement historique:', error);
                projectElements.projectsList.innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 20px;">Erreur de chargement</p>';
            }
        }
        
        async function startProjectTimer() {
            if (!projectState.currentItem) return;
            
            const isTask = projectState.currentCategory === 'tasks';
            
            try {
                const response = await fetch(`${API_URL}/time-entries/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        task_id: isTask ? projectState.currentItemId : null,
                        project_id: isTask ? null : projectState.currentItemId
                    })
                });
                
                const data = await response.json();
                projectState.currentEntryId = data.entry_id;
                
                projectState.isRunning = true;
                projectInterval = setInterval(() => {
                    projectState.currentItemSeconds++;
                    projectElements.projectTimer.textContent = formatTime(projectState.currentItemSeconds);
                    saveCompleteState();
                }, 1000);
                
                projectElements.btnStartProject.disabled = true;
                projectElements.btnStopProject.disabled = false;
                projectElements.categorySelect.disabled = true;
                projectElements.itemSelect.disabled = true;
            } catch (error) {
                console.error('Erreur démarrage timer projet:', error);
                alert('Erreur lors du démarrage du timer');
            }
        }
        
        async function stopProjectTimer() {
            clearInterval(projectInterval);
            
            try {
                await fetch(`${API_URL}/time-entries/${projectState.currentEntryId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        duration_seconds: projectState.currentItemSeconds
                    })
                });
                
                await updateProjectsList();
                await updateProjectsBarChart();
            } catch (error) {
                console.error('Erreur arrêt timer projet:', error);
            }
            
            projectState.isRunning = false;
            projectState.currentItemSeconds = 0;
            projectState.currentItem = null;
            projectState.currentItemId = null;
            projectState.currentEntryId = null;
            projectState.currentCategory = null;
            
            projectElements.projectTimerLabel.textContent = 'Aucun projet en cours';
            projectElements.projectTimer.textContent = '00:00:00';
            projectElements.categorySelect.value = '';
            projectElements.itemSelect.value = '';
            projectElements.itemSelect.disabled = true;
            projectElements.btnStartProject.disabled = true;
            projectElements.btnStopProject.disabled = true;
            projectElements.categorySelect.disabled = false;
        }
        
        function selectItem() {
            const selectedId = projectElements.itemSelect.value;
            if (!selectedId || projectState.isRunning) return;
            
            const category = projectElements.categorySelect.value;
            const items = category === 'tasks' ? projectState.tasks : projectState.projects;
            const item = items.find(i => i.id == selectedId);
            
            if (!item) return;
            
            projectState.currentItem = item.name;
            projectState.currentItemId = item.id;
            projectState.currentCategory = category;
            projectElements.projectTimerLabel.textContent = item.name;
            projectElements.btnStartProject.disabled = false;
            projectState.currentItemSeconds = 0;
            projectElements.projectTimer.textContent = '00:00:00';
        }
        
        projectElements.categorySelect.addEventListener('change', () => {
            updateItemSelect();
            projectElements.itemSelect.value = '';
            projectElements.btnStartProject.disabled = true;
        });
        projectElements.itemSelect.addEventListener('change', selectItem);
        projectElements.btnStartProject.addEventListener('click', startProjectTimer);
        projectElements.btnStopProject.addEventListener('click', stopProjectTimer);
        
        // ============================================
        // INITIALISATION
        // ============================================
        
        window.addEventListener('load', async () => {
            const authenticated = await checkAuth();
            if (authenticated) {
                await loadTodaySession();
                await loadTasksAndProjects();
                
                const restored = await restoreCompleteState();
                
                if (restored) {
                    console.log('🎉 Session restaurée ! Les timers ont repris où vous les aviez laissés.');
                } else {
                    console.log('📝 Nouvelle session');
                }
                
                updateCharts();
            }
        });
    </script>
</body>
</html>
